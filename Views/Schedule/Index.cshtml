@{
    ViewData["Title"] = "Schedule";
    ViewData["Path"] = new[] { "Schedule" };
    var alowTimeTable = @Html.Raw(ViewBag.AllowTimeTable);
    var point = ViewBag.Point;
}

<div class="card-body">
    <p>剩餘課堂數：<span id="remainPoint"></span></p>
    <div id="calendar"></div>
</div>
<div class="card-body">
    <form asp-controller="Schedule" asp-action="Selection" method="post" id="sendselectionsform">
        <input id="selectionscontent" style="display:none" name="Selections"/>
        <button type="button" onclick="sendselections()">Send Selections</button>
    </form>
</div>

@section Styles {
    <environment names="Development">
        <link rel="stylesheet" href="~/lib/fullcalendar/dist/fullcalendar.css"/>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/6.6.5/sweetalert2.css" rel="stylesheet" />
    </environment>
}

@section Scripts {
    <environment names="Development">
        <script type="text/javascript" src="~/lib/fullcalendar/dist/fullcalendar.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/6.6.5/sweetalert2.js"></script>
        <script>
            var point = @point;
            var remainPoint = @point;
            $('#remainPoint').text(remainPoint);
            function sendselections(){
                var selection = [];
                selectList = $("#calendar").fullCalendar('clientEvents', function (event) { return (event.rendering !== "background"); });
                $(selectList).each(function(index, value){
                    selection.push(value.start.format('YYYY/MM/DD HH:mm'));
                });
                if (selection.length == 0) {
                    swal({
                        title: '請選擇至少一堂課',
                        text: '你可以嘗試選擇套裝方案，會有更佳優惠的價格唷！',
                        type: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: '知道了'
                    });
                }
                else {
                    $('#selectionscontent').val(JSON.stringify(selection));
                    $('#sendselectionsform').submit();
                }
            }

            function calculatePoint(){
                selectList = $("#calendar").fullCalendar('clientEvents', function (event) { return (event.rendering !== "background"); });
                remainPoint = point - selectList.length;
                $('#remainPoint').text(remainPoint);
            }

            $(document).ready(function() {
                var date = new Date();
                var d = date.getDate();
                var m = date.getMonth();
                var y = date.getFullYear();
                var form = '';
                var today = new Date($.now());
                var weekday, end;
                var allowTimeTable = @(alowTimeTable);
                var convertTimeTable = [];
                var selectList = [];
                $(allowTimeTable).each(function(index, value){
                    if (value.WeekDay == 7)
                        weekday = 0;
                    else
                        weekday = value.WeekDay;
                    if (value.Time == '23:00:00')
                        end = moment(value.Time, 'HH:mm').add(1, 'minutes').format('HH:mm');
                    else
                        end = moment(value.Time, 'HH:mm').add(1, 'hours').format('HH:mm');
                    var item = {
                        dow: [weekday],
                        start: moment(value.Time, 'HH:mm').format('HH:mm'),
                        end: end
                    };
                    convertTimeTable.push(item);
                });

                var isValidEvent = function (start, end) {
                    var count = $("#calendar").fullCalendar('clientEvents', function (event) { return (event.rendering === "background") }).length;
                    return $("#calendar").fullCalendar('clientEvents', function (event) {
                        return (event.rendering === "background" &&
                        ((start.isBefore(event.start) && (end.isBefore(event.start) || end.isSame(event.start, 'hours'))) ||
                        ((start.isAfter(event.end) || start.isSame(event.end, 'hours')) && end.isAfter(event.end))));
                    }).length == count;
                };

                $('#calendar').fullCalendar({
                        height: 736,
                        header: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'month,agendaWeek'
                        },
                        slotDuration: "01:00:00",
                        slotLabelFormat: 'HH:mm',
                        navLinks: true, // can click day/week names to navigate views
                        selectable: true,
                        selectHelper: false,
                        slotEventOverlap: false,
                        allDaySlot: false,
                        selectConstraint: 'businessHours',
                        select: function (start, end) {
                            var view = $('#calendar').fullCalendar('getView');
                            if (view.name == 'month') {
                                $('#calendar').fullCalendar('changeView', 'agendaWeek');
                                $("#calendar").fullCalendar('gotoDate', start);
                            }
                            else {
                                if (isValidEvent(start, end) && remainPoint > 0) {
                                    var eventData;
                                    eventData = {
                                        title: '選課',
                                        start: start,
                                        end: end,
                                    };
                                    $('#calendar').fullCalendar('renderEvent', eventData, true);
                                    $('#calendar').fullCalendar('unselect');
                                    calculatePoint();
                                }
                                else {
                                    swal({
                                       title: '已無剩餘課堂數',
                                       text: '你可以嘗試選擇套裝方案，會有更佳優惠的價格唷！',
                                       type: 'warning',
                                       showCancelButton: true,
                                       confirmButtonColor: '#3085d6',
                                       cancelButtonColor: '#d33',
                                       confirmButtonText: '知道了'
                                    });
                                }
                            }
                        },
                        eventClick: function (calEvent, jsEvent, view) {
                            $('#calendar').fullCalendar('removeEvents', function (event) {
                                return event._id == calEvent._id;
                            });
                            calculatePoint();
                        },
                        editable: true,
                        eventLimit: true, // allow "more" link when too many events
                        eventOverlap: false,
                        eventDurationEditable: false,
                        displayEventTime: true,
                        displayEventEnd: true,
                        timeFormat: 'HH:mm',
                        businessHours: convertTimeTable
                });
            });
        </script>
    </environment>
}